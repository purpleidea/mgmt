language: go
os:
  - linux
go:
  - 1.9.x
  - 1.10.x
  - tip
go_import_path: github.com/purpleidea/mgmt
sudo: true
dist: trusty
# travis requires that you update manually, and provides this key to trigger it
apt:
  update: true
before_install:
  # as per a number of comments online, this might mitigate some flaky fails...
  - if [[ "$TRAVIS_OS_NAME" != "osx" ]]; then sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 0C49F3730359A14518585931BC711F9BA15703C6; fi
  # apt update tends to be flaky in travis, retry up to 3 times on failure
  # https://docs.travis-ci.com/user/common-build-problems/#travis_retry
  - if [[ "$TRAVIS_OS_NAME" != "osx" ]]; then travis_retry travis_retry sudo apt update; fi
  - git config remote.origin.fetch "+refs/heads/*:refs/remotes/origin/*"
  - git fetch --unshallow
install: 'make deps'
script: 'make test'
matrix:
  fast_finish: false
  allow_failures:
    - go: 1.10.x
    - go: tip
    - os: osx
  # include only one build for osx for a quicker build as the nr. of these runners are sparse
  include:
    - os: osx
      go: 1.9.x
# build deb, rpm and pkg packages for tagged releases
before_deploy:
  - ./misc/fpm-pack.sh
# upload packages for tagged releases
deploy:
  provider: releases
  api_key:
    secure: kIUVzr9BRu+ntAIiynPOQkcpJlQ5xM20NYNcqHW0yk5J2zpZqO9/077rDqoheIhPoHu+RopztuB5ikiAxbf21yQKsvQomp0tNrfDO2SPo2L7Srk5Wht4VgDZmCzyJBX09K2F4SHgi/DDB8ilIdHGEVvmAP37a81xvyYTHw98X2QSvWaKNJwUD/iLxeXdeE+YZseILUy5MZFgbLzqA7Xcbu0U+4EsH9IPgifIwgUA4u/xN+r4+OdmnI+snf9j3COkxUtdNUAkTLAJvT1PxB/KHfewfY7fzjEU4B1C4HSLrdZ/F+GHBpyNRbRHtudDRslIUeAudVdyqg+DmNfVH9VuoGT/3QuZx5J5O78caFcDqgzk5exBrw32xmBMKDnWsSr0bSGKjojH0QTo9TNyTBA6oydSM3tssXF6xluRdEjLPFFbqtJ54rdEO0xbwxfl5usMvT8w+bZOz18dKVXQB/0JrrrpLuBmqNwGQfPxlhpzDJW66eDrvhg9eJpJeeRnoj3XmK+o/JtiWrjKaoxDR8MedvNGBMmb4Z6Sj+aJFSRk4zE1p/tNVJs5H4+C48HmNKi49sKVPKUUbhn6iwYcLG+rCxou52MuoSelBvdc5156CvxsS7WNZXeEX2SyXMDgPD8TZZ63IHamv+FwMkUWlF8bCSaCr2nZzg8nQT9106aRUDk=
  skip_cleanup: true
  file_glob: true
  file:
    - ./*.deb
    - ./*.rpm
    - ./*.pkg.tar.xz
  on:
    repo: jonathangold/mgmt
    tags: true
    go: 1.9.x

# the "secure" channel value is the result of running: ./misc/travis-encrypt.sh
# with a value of: irc.freenode.net#mgmtconfig to eliminate noise from forks...
notifications:
  irc:
    channels:
      - secure: htcuWAczm3C1zKC9vUfdRzhIXM1vtF+q0cLlQFXK1IQQlk693/pM30Mmf2L/9V2DVDeps+GyLdip0ARXD1DZEJV0lK+Ca1qbHdFP1r4Xv6l5+jaDb5Y88YU5LI8K758QShiZJojuQ1aO2j8xmmt9V0/5y5QwlpPeHbKYBOFPBX3HvlT9DhvwZNKGhBb4qJOEaPVOwq9IkN3DyQ456MHcJ3q3vF9Lb440uTuLsJNof2AbYZH8ZIHCSG2N8tBj2qhJOpWQboYtQJzE2pRaGkGBL4kYcHZSZMXX8sl4cBM1vx/IRUkvBxJUpLJz2gn/eRI+/gr59juZE2K0+FOLlx9dLnX626Y9xSViopBI6JsIoHJDqNC7aGaF2qaYulGYN65VNKVqmghjgt6JLmmiKeH10hYrJMMvt2rms8l4+5iwmCwXvhH/WU9edzk2p5wqERMnostJFEJib0zI3yzLoF0sdJs+veKtagzfayY2d2l7hlmt951IpqqVWldVgWUcQKVvi8gmRarbwFlK+5D7BEnkUDcLNly/cqf7BgEeX6YfF+FiR4pgfOhYvGCD+2q91NgWQXHBCxbyN0be1TVdkXD94f0Lkn94VyEJJ+PkPlG+rPgFwGcjqN4oEGkJeJmES2If05q2Ms1dJLwYQDL3+Py4lNMSdSWj24TzlFVhtwHepuw=
    template:
      - "%{repository} (%{commit}: %{author}): %{message}"
      - "More info : %{build_url}"
    on_success: always
    on_failure: always
    use_notice: false
    skip_join: false
  email:
    recipients:
      - secure: qNkgP6QLl6VXpFQIxas2wggxvIiOmm1/hGRXm4BXsSFzHsJPvMamA3E1HEC7H+luiWTny1jtGSGgTJPV9CX1LtQV0g0S4ThaAvWuKvk3rXO8IVd++iA/Lh1s1H6JdKM0dJtLqFICawjeci4tOQzSvrM2eCBWqT0UYsrQsGHB6AF31GNAH0Acqd5cYeL+ZpbCN+hQEznAZQ7546N25TwqieI8Lg7nisA+lwYYwsaC2+f5RIeyvvKjQv3wzEdBAQ9CI9WQiTOUBnUnyYxMrdomQ/XGF66QnZy9vq5nEP83IFtuhPvSamL7ceT+yJW0jDyBi8sYEV7On7eXzjyHbiYpF4YHcJrFnf5RyV4kQGd6/SC8iZwK4Is4eyeAjDFTC+JafLajw9R9x9bK43BwlRAWOZxjFKe0cU/BVAjmlz87vHgUho2P41+0a5XfajfU6VhA5QFPK6rNH7W1CnA7D/0LmS0yaqJM1OCrm6LfoZEMhe0DxTJ9uWJbr0x1sYao6q8H4xYk+fyRgoBAr2TxYU7kXx8ThiRdzuQ8izdbojlzTYLe8liZMIsjL0axLsLK7YBWrjJUcDFDjR/DqmVxPrvbVFbCi9ChmBw0WmbJvDY0FV8T8dO8wCjg9JEmprAmWPyq0g/F87LFK4tAZqQFJGjP1qwsR9jdwdNTKeCdY656f/Y=
    on_failure: change
    on_success: change
